<%= content_for :body_class, "inner_body white_back" %>
<%= content_for :turn_turbolinks, "data-turbolinks=false" %>

<!-- header logo begin -->
<div class="container">
  <div class="row text-center space_top">
    <img src="https://remedicohealth.com/images/footer_logo_blue1-min.png" alt="Remedico">
  </div>
</div>
<!-- header logo end -->

<main id="form-step-4" style="width: 100%; overflow-y: hidden; overflow-x: hidden">

  <!-- version checkout, delivery info begin -->
  <div class="version_0">
    <!-- content section begin -->
    <section class="inner_content pad_15">
      <div class="container">
        <div class="row contactpopup_info">
          <div class="col-sm-12 box pad_0 margin_0">
            <div   class="row space_bottom">
              <div class="col-sm-12 col-md-6 col-md-offset-3">
                <div><h1 style="font-size:28px">Almost done, <span customer-name><%=current_user.name %></span>!</h1></div>
                <div>
                  <p class="p_16 margin_t_25 margin_b_45">
                  We have received your details. The final step is payment, so the doctor can prepare your treatment plan.
                  </p>
                </div>
                <div class="row margin_t_25">
                  <table class="billing-information col-md-12 col-sm-12 col-xs-12 p_16">
                    <thead>
                      <tr class="text-uppercase">
                        <th class="text-center color_blue" colspan="2"><b>Treatment Summary</b></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>
                          <table class="treatment-plan-table text-left">
                            <tr class="row">
                              <td class="col-md-3 col-sm-3 col-xs-3"><img src="<%= asset_path('treatment-plan-min.png') %>"></td>
                              <td class="col-md-9 col-sm-9 col-xs-9">Treatment Plan for</br><%= @current_consultation.category %></td>
                            </tr>
                          </table>
                        </td>
                        <td class="amount-right"><span class="element-number">Rs. 350</span></td>
                      </tr>
                      <tr><td class="hr-line" colspan="2"><div></div></td></tr>
                      <tr>
                        <td>
                          <table class="support-table margin_b_10 text-left">
                            <tr>
                              <td class="col-md-3 col-sm-3 col-xs-3"><img src="<%= asset_path('support-min.png') %>"></td>
                              <td class="col-md-9 col-sm-9 col-xs-9"><span class="element-number">30</span> day support for queries and issues</td>
                            </tr>
                          </table>
                        </td>
                        <td class="amount-right color_green">FREE</td>
                      </tr>
                      <% if @current_consultation.coupon %>
                      <tr><td class="hr-line" colspan="2"><div></div></td></tr>
                      <tr>
                        <td>
                          <table class="support-table margin_b_10 text-left">
                            <tr>
                              <td class="col-md-3 col-sm-3 col-xs-3"></td>
                              <td class="col-md-9 col-sm-9 col-xs-9 text-uppercase color_green">Promo applied</td>
                            </tr>
                          </table>
                        </td>
                        <td class="color_green amount-right">-Rs. <span class="element-number"><%= (350-@current_consultation.amount) %></span></td>
                      </tr>
                      <% end %>
                    </tbody>
                    <tfoot>
                      <tr><td class="hr-line" colspan="2"><div></div></td></tr>
                      <tr>
                        <td class="amount-right element-number" colspan="2"><strong><span class="text-uppercase">Total </span> Rs. <%= @current_consultation.amount %></strong></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div class="row margin_t_25">
                  <table class="delivery-information col-md-12 col-sm-12 col-xs-12 p_16">
                    <tbody>
                      <tr>
                        <td class="text-left">Delivery by</td>
                        <!-- 24 hours + 5:30 hours -->
                        <td class="amount-right"><strong>Tomorrow, <span class="element-number">
                          <%= (Time.now + 1770.minutes).strftime("%l %p") %>
                          </span></strong></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="row margin_t_25">
                  <table class="delivery-information col-md-12 col-sm-12 col-xs-12 p_16" id="email-static">
                    <tbody>
                      <tr>
                        <td class="text-left">Delivery to</td>
                        <td class="amount-right"><strong><span id="current_user_email"><%= @current_consultation.patient.email %></span></strong></td>
                      </tr>
                      <tr>
                        <td class="text-left"></td>
                        <td class="change-email pull-right"><button id="change-email">(change)</button></td>
                      </tr>
                    </tbody>
                  </table>
                  <table class="delivery-information col-md-12 col-sm-12 col-xs-12 p_16" id="email-editable">
                    <tbody>
                      <tr>
                        <td class="text-left">Delivery to</td>
                        <td class="amount-right">
                          <input type="text" id="email" size="25" class="text-right"></input>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-left"></td>
                        <td class="change-email-controls pull-right">
                          <div class="row">
                            <div class="col-xs-3 col-sm-3 col xs-3"><span id="change-email-controls-submit"><i class="fa fa-check"></i></span></div>
                            <div class="col-xs-3 col-sm-3 col xs-3"><span id="change-email-controls-cancel"><i class="fa fa-times"></i></span></div>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- content section end -->

    <!-- satisfaction guaranteed section begin -->
    <section class="satisfaction space_bottom">
      <div class="row text-center space_bottom space_top dotted-lines">
        <div class="col-md-8 col-md-offset-2 col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1">
          <div class="row margin_t_25 margin_b_15">

            <div class="col-md-6 col-sm-6 col-xs-12 satisfaction-content">
              <div class="row">
                <span class="item-icon"><img class="icon-set" style="max-width:90%" src="<%= asset_path("satisfaction_icon_blue_light_sm.png") %>" alt="Remedico"></span>
                <div class="text-left">
                  <h5 class="sub-title color_blue">100% satisfaction</h5>
                  <p class="p_16 margin_b_0">If you're not satisfied with your consultation, we will refund your fee.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-12 satisfaction-content">
              <div class="row">
                <span class="item-icon"><img class="icon-set" src="<%= asset_path("secure_icon_sm.png") %>" alt="Remedico"></span>
                <div class="text-left">
                  <h5 class="sub-title color_blue">Secure Information</h5>
                  <p class="p_16">Your information and photos are only shared with the doctors.</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
    <!-- satisfaction guaranteed section end -->
  </div>
  <!-- version end -->

  <!-- version checkout, no delivery info begin -->
  <div class="version_1">
    <!-- content section begin -->
    <section class="inner_content pad_15">
      <div class="container">
        <div class="row contactpopup_info">
          <div class="col-sm-12 box pad_0 margin_0">
            <div   class="row space_bottom">
              <div class="col-sm-12 col-md-6 col-md-offset-3">
                <div><h1 style="font-size:28px">Almost done, <span customer-name><%=current_user.name %></span>!</h1></div>
                <div>
                  <p class="p_16 margin_t_25">
                  The final step is the payment.
                  </p>
                </div>
                
                <!-- three step process desktop version -->
                <div class="row desktop margin_b_25">
                  <div class="col-md-12 margin_t_25">
                    <img src="<%= asset_path("progress_bar_web.png") %>" />
                  </div>
                </div>
                <!-- three step process mobile version -->
                <div class="row mobile margin_b_25">
                  <div class="col-md-12 margin_t_10">
                    <img src="<%= asset_path("progress_bar_mobile.png") %>" />
                  </div>
                </div>

                <div class="row margin_t_25">
                  <table class="billing-information col-md-12 col-sm-12 col-xs-12 p_16">
                  <thead>
                    <tr class="text-uppercase">
                      <th class="text-center" colspan="2"><b>Treatment Summary</b></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <table class="treatment-plan-table text-left">
                          <tr class="row">
                            <td class="col-md-3 col-sm-3 col-xs-3"><img src="<%= asset_path('treatment-plan-min.png') %>"></td>
                            <td class="col-md-9 col-sm-9 col-xs-9">Treatment Plan for</br><%= @current_consultation.category %></td>
                          </tr>
                        </table>
                      </td>
                      <td class="amount-right">Rs. 350</td>
                    </tr>
                    <tr>
                      <td>
                        <table class="support-table margin_b_10 text-left">
                          <tr>
                            <td class="col-md-3 col-sm-3 col-xs-3"><img src="<%= asset_path('support-min.png') %>"></td>
                            <td class="col-md-9 col-sm-9 col-xs-9">30 day support for queries and issues</td>
                          </tr>
                        </table>
                      </td>
                      <td class="amount-right">FREE</td>
                    </tr>
                    <% if @current_consultation.coupon %>
                    <tr class="promo-section text-left">
                      <td class="text-uppercase">Promo applied</td>
                      <td class="color_green amount-right">-Rs. <%= (350-@current_consultation.amount) %></td>
                    </tr>
                    <% end %>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td class="text-uppercase text-left"><b>Total</b></td>
                      <td class="amount-right"><strong>Rs. <%= @current_consultation.amount %></strong></td>
                    </tr>
                  </tfoot>
                </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- content section end -->

    <!-- satisfaction guaranteed section begin -->
    <section class="satisfaction space_bottom">
      <div class="row text-center space_bottom space_top dotted-lines">
        <div class="col-md-8 col-md-offset-2 col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1">
          <div class="row margin_t_25 margin_b_15">

            <div class="col-md-6 col-sm-6 col-xs-12 satisfaction-content">
              <div class="row">
                <span class="item-icon"><img class="icon-set" style="max-width:90%" src="<%= asset_path("satisfaction_icon_blue_light_sm.png") %>" alt="Remedico"></span>
                <div class="text-left">
                  <h5 class="sub-title color_blue">100% satisfaction</h5>
                  <p class="p_16 margin_b_0">If you're not satisfied with your consultation, we will refund your fee.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-12 satisfaction-content">
              <div class="row">
                <span class="item-icon"><img class="icon-set" src="<%= asset_path("secure_icon_sm.png") %>" alt="Remedico"></span>
                <div class="text-left">
                  <h5 class="sub-title color_blue">Secure Information</h5>
                  <p class="p_16">Your information and photos are only shared with the doctors.</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
    <!-- satisfaction guaranteed section end -->
  </div>
  <!-- version 1 end -->

  <!-- payment section begin -->
  <section>
    <div class="row margin_t_25">
      <div class="col-sm-12 text-center space_bottom margin_t_15">
        <img src="<%= asset_path("payment_options/master_card_visa_paytm.png") %>" class="img-responsive" alt="Satisfaction-Payment-Gateway" style="display: inline-block; max-height: 25px;">
        <h5 class="sub-title space_bottom">Total payment: Rs. <%= @amount %></h5>
      </div>
      <div class="col-sm-12 sticky-footer">
        <div class="text-center">
            <%= button_tag(name: "type", class: "list_btn_dark hover sticky-footer", :id=> "paytmPayBtn") do %>
              <i class="fa fa-lock" aria-hidden="true"></i> <span class="version_experiment">PAY Rs. <%= @amount %> SECURELY NOW</span>
            <% end %>
        </div>
      </div>
    </div>
  </section>
  <!-- payment section end -->

  <!-- footer begin -->
  <section>
    <div class="col-sm-12 space_top space_bottom text-center no-scroll" style="" id="fixed-footer">
      <h5 class="sub-title">Still have questions?</h5>
      <p class="p_16">
        Feel free to contact us at <span><nobr><a href="tel:+918433484696"> &nbsp; <span class="fa fa-whatsapp icon-blue"></span>&nbsp;+91 8433 848 969</a></nobr></span>
      </p>
    </div> 
  </section>
  <!-- footer end -->

</main>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script type="text/javascript">

$(function() {
  var options = {
      "key": "<%= Rails.application.secrets.RAZOR_PAY_KEY_ID %>",
      "amount": "<%= current_consultation.amount*100 %>",
      "name": "Remedico",
      "description": "Treatment plan",
      "image": "<%= asset_path('logo100x100.png') %>",
      "handler": function (response){
        var mapForm = document.createElement("form");
        mapForm.target = "_self";
        mapForm.method = "POST";
        mapForm.action = "/consult/payment/success";

        var mapInput = document.createElement("input");
        mapInput.type = "hidden";
        mapInput.name = "payment_id";
        mapInput.value = response.razorpay_payment_id;

        var mapInput2 = document.createElement("input");
        mapInput2.name = "authenticity_token"
        mapInput2.value = "<%= form_authenticity_token %>"
        mapInput2.type = "hidden"

        var mapInput3 = document.createElement("input");
        mapInput3.name = "pg_type"
        mapInput3.value = "RAZORPAY"
        mapInput3.type = "hidden"

        mapForm.appendChild(mapInput);
        mapForm.appendChild(mapInput2);
        mapForm.appendChild(mapInput3);
        document.body.appendChild(mapForm);

        mapForm.submit();

      },
      "external": {
        wallets: ['paytm'],
        handler: function(data) {
          // write code on how to handle the external wallet here, based on the param 'data'
          if(data.wallet === "paytm") {
            var mapForm = document.createElement("form");
            mapForm.target = "_self";
            mapForm.method = "POST";
            mapForm.action = "/consult/payment/payment_paytm";
            var mapInput = document.createElement("input");
            mapInput.name = "authenticity_token"
            mapInput.value = "<%= form_authenticity_token %>"
            mapInput.type = "hidden"
            var mapInput2 = document.createElement("input");
            mapInput2.name = "pg_type"
            mapInput2.value = "PAYTM"
            mapInput2.type = "hidden"
        
            mapForm.appendChild(mapInput);
            mapForm.appendChild(mapInput2);
            document.body.appendChild(mapForm);

            mapForm.submit();
          }
        }
      },
      "prefill": {
          "name": "<%= current_user.name %>",
          "contact": "<%= current_user.mobile %>",
          "email": "<%= current_user.email %>"
      },
      "theme": {
          "color": "#17a6b0"
      },
      "modal": {
          "ondismiss": function(){
            ga('send', 'event', { eventCategory: 'consultation', eventAction: 'RazorpayModalDismissed', consultationID: <%= current_consultation.id %>});
          }
      }
  };
  var rzp1 = new Razorpay(options);

  $('.sticky-footer').on('click', '#payBtn', function () {
    rzp1.open();
    $.ajax({
      type: "POST",
      url: "/consult/payment/initiate_payment",
      success: function (response) {
        return false;
      },
      error: function (response) {
        return false;
      }
    })
    ga('send', 'event', { eventCategory: 'consultation', eventAction: 'clickPayButton'});
    mixpanel.track("Button Clicked", {
      "Button Name": "Payment Button",
      "Condition Name": "n/a",
      "Page URL": "payment/index",
    });
    window._fbq.push(['track', 'Payment Button Clicked',{'Page URL':'payment/index'}]);
  });

  $('.sticky-footer').on('click', '#paytmPayBtn', function () {
    // $.ajax({
    //   type: "POST",
    //   url: "/consult/payment/initiate_payment",
    //   success: function (response) {
        var mapForm = document.createElement("form");
        mapForm.target = "_self";
        mapForm.method = "POST";
        mapForm.action = "/consult/payment/payment_paytm";
        var mapInput = document.createElement("input");
        mapInput.name = "authenticity_token"
        mapInput.value = "<%= form_authenticity_token %>"
        mapInput.type = "hidden"
        var mapInput2 = document.createElement("input");
        mapInput2.name = "pg_type"
        mapInput2.value = "PAYTM"
        mapInput2.type = "hidden"

        mapForm.appendChild(mapInput);
        mapForm.appendChild(mapInput2);
        document.body.appendChild(mapForm);

        mapForm.submit();

        ga('send', 'event', { eventCategory: 'consultation', eventAction: 'clickPayButton'});
        mixpanel.track("Button Clicked", {
          "Button Name": "Payment Button",
          "Condition Name": "n/a",
          "Page URL": "payment/index",
        });
        window._fbq.push(['track', 'Payment Button Clicked',{'Page URL':'payment/index'}]);
    //     return false;
    //   },
    //   error: function (response) {
    //     return false;
    //   }
    // })
  });

  mixpanel.track("Page Loaded", {
    "Page Name": "Payments Index Page",
    "Condition Name": 'n/a',
  });
  window._fbq.push(['track', 'Payments Page Load',{'Page URL':'payment/index'}]);

  /* save the current window state on load */
  if (window.history && window.history.pushState) {
    /* added city parameter manually */
    window.history.pushState('forward', null, './payment?city=null#');

    /* trigger on back button */
    window.onpopstate = function(e) {
      var state = $('.razorpay-container').css('display');
      if (state=='none') {
        var r = confirm("Warning: Are you sure you want to cancel your consultation?");
        if (r == true) {
          window.location = '/consult'
          return false;
        } else {
        e.preventDefault();
        }
      } else if (state='block') {
        rzp1.close();
      }
    }
  }
});

</script>
<!--Start of Tawk.to Script-->
<!--<script type="text/javascript">-->
<!--var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();-->
<!--(function(){-->
<!--var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];-->
<!--s1.async=true;-->
<!--s1.src='https://embed.tawk.to/59dc7c6cc28eca75e4625231/default';-->
<!--s1.charset='UTF-8';-->
<!--s1.setAttribute('crossorigin','*');-->
<!--s0.parentNode.insertBefore(s1,s0);-->
<!--})();-->
<!--</script>-->
<!--End of Tawk.to Script-->
